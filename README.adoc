= OpenShift Installation
Álvaro López Medina <alopezme@redhat.com>
v1.0, 2023-09
// Metadata
:description: This repository explores the different ways to install Openshift
:keywords: openshift, red hat, baremetal, installation
// Create TOC wherever needed
:toc: macro
:sectanchors:
:sectnumlevels: 2
:sectnums: 
:source-highlighter: pygments
:imagesdir: docs/images
// Start: Enable admonition icons
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
// Icons for GitHub
:yes: :heavy_check_mark:
:no: :x:
endif::[]
ifndef::env-github[]
:icons: font
// Icons not for GitHub
:yes: icon:check[]
:no: icon:times[]
endif::[]
// End: Enable admonition icons


This repository explores the different ways to install Openshift.

// Create the Table of contents here
toc::[]

== Introduction


In this repository, I will focus on the Agent-based installation. This is a subcommand of the OpenShift Container Platform installer. It generates a bootable ISO image containing all of the information required to deploy an OpenShift Container Platform cluster, with an available release image.






== Single Node Operator


=== Create the Vms

==== Using Kcli

.Useful kcli commands
[source, bash]
----
kcli create plan -f kcli-plan-acm.yaml acm # Create the OCP plan with name acm
kcli start plan acm
kcli stop plan acm
kcli get vm
kcli delete plan acm
----

==== Using vSphere

.Openshift Console
image::vsphere-vm-details.png[]

NOTE: Then, you can edit the name of the VM after installation to `sno-node`.

Alternatively, use the https://github.com/vmware/govmomi/blob/main/govc/USAGE.md#vmcreate[govc vm.create] command:

[source, bash]
----
source ./ocp-sno/env-vars && govc vm.create --dc=SDDC-Datacenter -c 8 -m=16384 -folder=$(govc ls /SDDC-Datacenter/vm/Workloads) -net=$(govc ls /SDDC-Datacenter/network | grep segment) -on=false test
govc device.cdrom.add -vm test

----





=== Generate the ISO Image

.Generate files from the template
[source, bash]
----
source ./ocp-sno/env-vars && cat ./ocp-sno/install-config-template.yaml | envsubst > ./agent/install-config.yaml
source ./ocp-sno/env-vars && cat ./ocp-sno/agent-config-template.yaml | envsubst > ./agent/agent-config.yaml
----

NOTE: Remember that the NMState has to be installed in the node you launch the iso generation: `sudo dnf install nmstate`.

.Generate ISO image
[source, bash]
----
openshift-install --dir ./agent agent create image
----




==== Upload ISO image to VMWare

We use the https://github.com/vmware/govmomi/tree/main/govc[govc] CLI.

.Using govc
[source, bash]
----
source ocp-sno/env-vars
# List all VMs
govc ls -l=true $(govc ls /SDDC-Datacenter/vm/Workloads)

# Get VM info
govc vm.info sno-node
----

.Upload ISO image
[source, bash]
----
govc datastore.upload --dc=SDDC-Datacenter --ds=WorkloadDatastore ./agent/agent.x86_64.iso agent2/alvaro-agent.x86_64.iso
----






=== Begin the installation

.Verify the installation
[source, bash]
----
openshift-install --dir ./agent agent wait-for bootstrap-complete --log-level=debug

openshift-install --dir ./agent agent wait-for install-complete --log-level=debug
----







== OCP HA installation

=== Generate the ISO Image

.Generate files from the template
[source, bash]
----
source ./ocp/env-vars && cat ./ocp/install-config-template.yaml | envsubst > ./agent/install-config.yaml
source ./ocp/env-vars && cat ./ocp/agent-config-template.yaml | envsubst > ./agent/agent-config.yaml
----

NOTE: Remember that the NMState has to be installed in the node you launch the iso generation: `sudo dnf install nmstate`.

.Generate ISO image
[source, bash]
----
openshift-install --dir ./agent agent create image
----




==== Upload ISO image to VMWare

We use the https://github.com/vmware/govmomi/tree/main/govc[govc] CLI.

.Using govc
[source, bash]
----
source ocp/env-vars
# List all VMs
govc ls -l=true $(govc ls /SDDC-Datacenter/vm/Workloads)

# Get VM info
govc vm.info sno-node
----

.Upload ISO image
[source, bash]
----
govc datastore.upload --dc=SDDC-Datacenter --ds=WorkloadDatastore ./agent/agent.x86_64.iso agent2/alvaro-ha/agent.x86_64.iso
----


=== Create the VMs


.Verify the installation
[source, bash]
----
cd Ansible

ansible-playbook -vvv -i inventory create-vms.yaml
----




=== Begin the installation

.Verify the installation
[source, bash]
----
openshift-install --dir ./agent agent wait-for bootstrap-complete --log-level=debug

openshift-install --dir ./agent agent wait-for install-complete --log-level=debug
----



.How to connect to the cluster
[NOTE]
====

* Using the web console: `echo "https://console-openshift-console.apps.$CLUSTER_NAME.$CLUSTER_BASE_DOMAIN"`.
* Using the kubeadmin: `echo "oc login -v 9 --insecure-skip-tls-verify=true -u kubeadmin --server=https://api.$CLUSTER_NAME.$CLUSTER_BASE_DOMAIN:6443"`
* Using the kubeconfig: `KUBECONFIG=agent/auth/kubeconfig oc get pods -A`.

====






== Automation execution environments

Automation execution environments are container images on which all automation in Red Hat Ansible Automation Platform is run.


[source, bash]
----
# Installation
sudo dnf config-manager --enable ansible-automation-platform-2.1-for-rhel-8-x86_64-rpms
sudo dnf install ansible-builder

----


Documentation:

* https://access.redhat.com/documentation/en-us/red_hat_ansible_automation_platform/2.4/html-single/creating_and_consuming_execution_environments/index[Creating and Consuming Execution Environments].





== Mirroring the RH registry


[source, bash]
----
# Login to the Red Hat Registry using your Customer Portal credentials
mkdir $XDG_RUNTIME_DIR/containers
cp mirror/auth.json $XDG_RUNTIME_DIR/containers/auth.json

# Generate initial config file (Then modify manually the location and the catalog version)
oc mirror init --registry example.com/mirror/oc-mirror-metadata > ./mirror/imageset-config.yaml

# Mirror it locally
oc mirror -v 3 --config ./mirror/imageset-config.yaml file://mirror-to-disk

# After copying it to the new folder, generate the registry
oc mirror --from=./mirror_seq1_000000.tar docker://registry.example:5000
----

The previous process is based on this documentation:

* https://docs.openshift.com/container-platform/4.12/installing/disconnected_install/index.html[About disconnected installation mirroring].
* https://docs.openshift.com/container-platform/4.12/installing/installing_with_agent_based_installer/understanding-disconnected-installation-mirroring.html[Mirroring images for a disconnected installation through the Agent-based Installer].





== Throubleshooting

[source, bash]
----
ssh core@$MASTER_0_IP_ADD_0

ssh-keygen -R $MASTER_0_IP_ADD_0
----